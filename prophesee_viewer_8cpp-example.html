<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Prophesee Driver API: prophesee_viewer.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="icon.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Prophesee Driver API
   &#160;<span id="projectnumber">1.4.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">prophesee_viewer.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>Example of using Prophesee Driver API for visualizing events stream.</p>
<div class="fragment"><div class="line"><span class="comment">/*******************************************************************</span></div><div class="line"><span class="comment"> * File : prophesee_viewer.cpp                                     *</span></div><div class="line"><span class="comment"> *                                                                 *</span></div><div class="line"><span class="comment"> * Copyright: (c) 2015-2019 Prophesee                              *</span></div><div class="line"><span class="comment"> *******************************************************************/</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;boost/program_options.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;prophesee_driver.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;utils/tone_mapper.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div><div class="line"><span class="preprocessor">#if CV_MAJOR_VERSION &gt;= 4</span></div><div class="line"><span class="preprocessor">#include &lt;opencv2/highgui/highgui_c.h&gt;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;utils/cd_frame_generator.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;utils/em_frame_generator.h&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> ESCAPE = 27;</div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> SPACE  = 32;</div><div class="line"></div><div class="line"><span class="keyword">namespace </span>po = boost::program_options;</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> process_ui_for(<span class="keywordtype">int</span> delay_ms) {</div><div class="line">    <span class="keyword">auto</span> then = std::chrono::high_resolution_clock::now();</div><div class="line">    <span class="keywordtype">int</span> key   = cv::waitKey(delay_ms);</div><div class="line">    <span class="keyword">auto</span> now  = std::chrono::high_resolution_clock::now();</div><div class="line">    <span class="comment">// cv::waitKey will not wait if no window is opened, so we wait for him, if needed</span></div><div class="line">    std::this_thread::sleep_for(std::chrono::milliseconds(</div><div class="line">        delay_ms - std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(now - then).count()));</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> key;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">bool</span> window_was_closed(<span class="keyword">const</span> std::string &amp;window_name) {</div><div class="line"><span class="comment">// Small hack: if the window has been closed, it is not visible anymore or property changes from the one we set</span></div><div class="line"><span class="preprocessor">#if CV_MAJOR_VERSION &gt;= 3 &amp;&amp; CV_MINOR_VERSION &gt;= 2</span></div><div class="line">    <span class="keywordflow">if</span> (cv::getWindowProperty(window_name, cv::WND_PROP_VISIBLE) == 0) {</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">if</span> (cv::getWindowProperty(window_name, cv::WND_PROP_AUTOSIZE) != 0) {</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> setup_cd_callback_and_window(<a name="_a0"></a><a class="code" href="classProphesee_1_1Camera.html">Prophesee::Camera</a> &amp;camera, cv::Mat &amp;cd_frame,</div><div class="line">                                 <a name="_a1"></a><a class="code" href="classProphesee_1_1CDFrameGenerator.html">Prophesee::CDFrameGenerator</a> &amp;cd_frame_generator, <span class="keyword">const</span> std::string &amp;window_name) {</div><div class="line">    <span class="keyword">auto</span> &amp;geometry = camera.<a name="a2"></a><a class="code" href="classProphesee_1_1Camera.html#add2264902d5c3cfe0c031ddf1ec693a0">geometry</a>();</div><div class="line">    <span class="keyword">auto</span> <span class="keywordtype">id</span>        = camera.<a name="a3"></a><a class="code" href="classProphesee_1_1Camera.html#a49241bf1af8d9e935a6a4c849892b299">cd</a>().<a name="a4"></a><a class="code" href="classProphesee_1_1CD.html#affe11644cda56792434a22819ed1aec6">add_callback</a>(</div><div class="line">        [&amp;cd_frame_generator](<span class="keyword">const</span> <a name="_a5"></a><a class="code" href="classProphesee_1_1Event2dTD.html">Prophesee::EventCD</a> *ev_begin, <span class="keyword">const</span> <a class="code" href="classProphesee_1_1Event2dTD.html">Prophesee::EventCD</a> *ev_end) {</div><div class="line">            cd_frame_generator.<a name="a6"></a><a class="code" href="classProphesee_1_1CDFrameGenerator.html#a87aa2e5d26143f877e3f2e23d43f5e16">add_events</a>(ev_begin, ev_end);</div><div class="line">        });</div><div class="line">    cd_frame_generator.<a name="a7"></a><a class="code" href="classProphesee_1_1CDFrameGenerator.html#aae28e806eb36ea412861414dd2b5df59">start</a>(</div><div class="line">        30, [&amp;cd_frame](<span class="keyword">const</span> Prophesee::timestamp &amp;ts, <span class="keyword">const</span> cv::Mat &amp;frame) { frame.copyTo(cd_frame); });</div><div class="line">    cv::namedWindow(window_name, CV_GUI_EXPANDED);</div><div class="line">    cv::resizeWindow(window_name, geometry.width(), geometry.height());</div><div class="line">    <span class="comment">// move needs to be after resize on apple, otherwise the window stacks</span></div><div class="line">    cv::moveWindow(window_name, 0, 0);</div><div class="line">    <span class="keywordflow">return</span> id;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> setup_em_callback_and_window(<a class="code" href="classProphesee_1_1Camera.html">Prophesee::Camera</a> &amp;camera, cv::Mat &amp;em_frame,</div><div class="line">                                 <a name="_a8"></a><a class="code" href="classProphesee_1_1EMFrameGenerator.html">Prophesee::EMFrameGenerator</a> &amp;em_frame_generator, <span class="keyword">const</span> std::string &amp;window_name) {</div><div class="line">    <span class="keyword">auto</span> &amp;geometry = camera.<a class="code" href="classProphesee_1_1Camera.html#add2264902d5c3cfe0c031ddf1ec693a0">geometry</a>();</div><div class="line">    <span class="keywordflow">try</span> {</div><div class="line">        <span class="keyword">auto</span> <span class="keywordtype">id</span> = camera.<a name="a9"></a><a class="code" href="classProphesee_1_1Camera.html#aa90e9aab54d8beabf380bd7eee7f5994">em</a>().<a name="a10"></a><a class="code" href="classProphesee_1_1EM.html#a58c24bfe69ec67573e03def28adea0f6">add_callback</a>(</div><div class="line">            [&amp;em_frame_generator](<span class="keyword">const</span> <a name="_a11"></a><a class="code" href="classProphesee_1_1Event2dAPS.html">Prophesee::EventEM</a> *ev_begin, <span class="keyword">const</span> <a class="code" href="classProphesee_1_1Event2dAPS.html">Prophesee::EventEM</a> *ev_end) {</div><div class="line">                em_frame_generator.<a name="a12"></a><a class="code" href="classProphesee_1_1EMFrameGenerator.html#afd5ba7573c3948677a3e716c87963d47">add_events</a>(ev_begin, ev_end);</div><div class="line">            });</div><div class="line">        em_frame_generator.<a name="a13"></a><a class="code" href="classProphesee_1_1EMFrameGenerator.html#a3930cb3556028ef093f1c0e6c9a5cdec">start</a>(</div><div class="line">            30, [&amp;em_frame](<span class="keyword">const</span> Prophesee::timestamp &amp;ts, <span class="keyword">const</span> cv::Mat &amp;frame) { frame.copyTo(em_frame); });</div><div class="line">        cv::namedWindow(window_name, CV_GUI_EXPANDED);</div><div class="line">        cv::resizeWindow(window_name, geometry.width(), geometry.height());</div><div class="line">        <span class="comment">// move needs to be after resize on apple, otherwise the window stacks</span></div><div class="line">        cv::moveWindow(window_name, geometry.width() + 100, geometry.height() + 100);</div><div class="line">        <span class="keywordflow">return</span> id;</div><div class="line">    } <span class="keywordflow">catch</span> (<a name="_a14"></a><a class="code" href="classProphesee_1_1CameraException.html">Prophesee::CameraException</a> &amp;e) {</div><div class="line">        <span class="keywordflow">if</span> (e.code().value() &amp; Prophesee::CameraErrorCode::UnsupportedFeature)</div><div class="line">            <span class="keywordflow">return</span> -1;</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">            std::cerr &lt;&lt; e.what() &lt;&lt; std::endl;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> -2;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> setup_graylevel_frame_callback_and_window(<a class="code" href="classProphesee_1_1Camera.html">Prophesee::Camera</a> &amp;camera, cv::Mat &amp;graylevel_frame,</div><div class="line">                                              Prophesee::Utils::GammaToneMapper &amp;tone_mapper,</div><div class="line">                                              <span class="keyword">const</span> std::string &amp;window_name) {</div><div class="line">    <span class="keyword">auto</span> &amp;geometry = camera.<a class="code" href="classProphesee_1_1Camera.html#add2264902d5c3cfe0c031ddf1ec693a0">geometry</a>();</div><div class="line">    <span class="keywordflow">try</span> {</div><div class="line">        camera.<a name="a15"></a><a class="code" href="classProphesee_1_1Camera.html#a3a2e042b7553c4ee300438c189fbf65c">set_exposure_frame_callback</a>(30,</div><div class="line">                                           [&amp;graylevel_frame, &amp;tone_mapper](Prophesee::timestamp ts, <span class="keyword">const</span> cv::Mat &amp;f) {</div><div class="line">                                               tone_mapper(f, graylevel_frame);</div><div class="line">                                           });</div><div class="line">        cv::namedWindow(window_name, CV_GUI_EXPANDED);</div><div class="line">        cv::resizeWindow(window_name, geometry.width(), geometry.height());</div><div class="line">        <span class="comment">// move needs to be after resize on apple, otherwise the window stacks</span></div><div class="line">        cv::moveWindow(window_name, geometry.width() + 100, 0);</div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">    } <span class="keywordflow">catch</span> (<a class="code" href="classProphesee_1_1CameraException.html">Prophesee::CameraException</a> &amp;e) {</div><div class="line">        <span class="keywordflow">if</span> (e.code().value() &amp; Prophesee::CameraErrorCode::UnsupportedFeature)</div><div class="line">            <span class="keywordflow">return</span> -1;</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">            std::cerr &lt;&lt; e.what() &lt;&lt; std::endl;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> -2;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">bool</span> is_imu_available(<a class="code" href="classProphesee_1_1Camera.html">Prophesee::Camera</a> &amp;camera) {</div><div class="line">    <span class="keywordflow">try</span> {</div><div class="line">        camera.<a name="a16"></a><a class="code" href="classProphesee_1_1Camera.html#a3bca5213536c49a585fd827876882ca2">imu_sensor</a>();</div><div class="line">    } <span class="keywordflow">catch</span> (<a class="code" href="classProphesee_1_1CameraException.html">Prophesee::CameraException</a> &amp;) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) {</div><div class="line">    std::string serial;</div><div class="line">    std::string biases_file;</div><div class="line">    std::string filename;</div><div class="line">    std::string filename_to_log_into;</div><div class="line">    std::vector&lt;uint16_t&gt; roi;</div><div class="line">    uint32_t max_rate_kEV_s = 10000;</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> do_retry = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> std::string program_desc =</div><div class="line">        <span class="stringliteral">&quot;\nSimple viewer to stream events from a prophesee rawfile or device, using the prophesee-driver API.\n\n&quot;</span></div><div class="line">        <span class="stringliteral">&quot;Press SPACE key while running to record or stop recording raw data\n&quot;</span></div><div class="line">        <span class="stringliteral">&quot;Press &#39;q&#39; or Escape key to leave the program.\n&quot;</span></div><div class="line">        <span class="stringliteral">&quot;Press &#39;c&#39; to toggle the CD callback and associated window that displays events.\n&quot;</span></div><div class="line">        <span class="stringliteral">&quot;Press &#39;e&#39; to toggle the EM callback and associated window that displays a frame of tone mapped graylevel &quot;</span></div><div class="line">        <span class="stringliteral">&quot;frame computed from differences of EM (if available).\n&quot;</span></div><div class="line">        <span class="stringliteral">&quot;Press &#39;f&#39; to toggle the graylevel frame callback and associated window that displays a frame of tone mapped &quot;</span></div><div class="line">        <span class="stringliteral">&quot;graylevel frame computed from CD and EM (if available).\n&quot;</span></div><div class="line">        <span class="stringliteral">&quot;Press &#39;d&#39; to toggle the max event rate given as input.\n&quot;</span></div><div class="line">        <span class="stringliteral">&quot;Press &#39;r&#39; to toggle the hardware ROI given as input.\n&quot;</span></div><div class="line">        <span class="stringliteral">&quot;Press &#39;i&#39; to print imu informations (if available).\n&quot;</span></div><div class="line">        <span class="stringliteral">&quot;Press &#39;h&#39; to print this help.&quot;</span>;</div><div class="line"></div><div class="line">    po::options_description desc(program_desc + <span class="stringliteral">&quot;\nAllowed options&quot;</span>);</div><div class="line">    <span class="comment">// clang-format off</span></div><div class="line">    desc.add_options()</div><div class="line">        (<span class="stringliteral">&quot;help,h&quot;</span>, <span class="stringliteral">&quot;Print this help message&quot;</span>)</div><div class="line">        (<span class="stringliteral">&quot;serial,s&quot;</span>, po::value&lt;std::string&gt;(&amp;serial)-&gt;default_value(<span class="stringliteral">&quot;&quot;</span>),<span class="stringliteral">&quot;Serial ID of the camera. This flag is incompatible with flag &#39;filename&#39;&quot;</span>)</div><div class="line">        (<span class="stringliteral">&quot;filename,f&quot;</span>, po::value&lt;std::string&gt;(&amp;filename)-&gt;default_value(<span class="stringliteral">&quot;&quot;</span>), <span class="stringliteral">&quot;Path to a rawfile to read. If not specified, the camera live stream is used.&quot;</span>)</div><div class="line">        (<span class="stringliteral">&quot;biases,b&quot;</span>, po::value&lt;std::string&gt;(&amp;biases_file)-&gt;default_value(<span class="stringliteral">&quot;&quot;</span>), <span class="stringliteral">&quot;Path to a biases file. If not specified, the camera will be configured with the default biases.&quot;</span>)</div><div class="line">        (<span class="stringliteral">&quot;max-rate&quot;</span>, po::value&lt;uint32_t&gt;(&amp;max_rate_kEV_s)-&gt;default_value(10000), <span class="stringliteral">&quot;Max event rate to set (by pressing &#39;d&#39;). [kev/s].&quot;</span>)</div><div class="line">        (<span class="stringliteral">&quot;output,o&quot;</span>, po::value&lt;std::string&gt;(&amp;filename_to_log_into)-&gt;default_value(<span class="stringliteral">&quot;data.raw&quot;</span>), <span class="stringliteral">&quot;Path to a rawfile used for data recording. Default value is &#39;data.raw&#39;. It also works when reading data from a rawfile.&quot;</span>)</div><div class="line">        (<span class="stringliteral">&quot;roi,r&quot;</span>, po::value&lt;std::vector&lt;uint16_t&gt;&gt;(&amp;roi)-&gt;multitoken(), <span class="stringliteral">&quot;Hardware roi to set on the sensor in the format [x y width height]&quot;</span>)</div><div class="line">    ;</div><div class="line">    <span class="comment">// clang-format on</span></div><div class="line">    po::variables_map vm;</div><div class="line">    <span class="keywordflow">try</span> {</div><div class="line">        po::store(po::command_line_parser(argc, argv).options(desc).run(), vm);</div><div class="line"></div><div class="line">        po::notify(vm);</div><div class="line">    } <span class="keywordflow">catch</span> (...) {</div><div class="line">        std::cout &lt;&lt; desc &lt;&lt; std::endl;</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (vm.count(<span class="stringliteral">&quot;help&quot;</span>)) {</div><div class="line">        std::cout &lt;&lt; desc &lt;&lt; std::endl;</div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (vm.count(<span class="stringliteral">&quot;roi&quot;</span>)) {</div><div class="line">        <span class="keywordflow">if</span> (roi.size() != 4) {</div><div class="line">            std::cerr &lt;&lt; <span class="stringliteral">&quot;Warning: ROI as argument must be in the format &#39;x y width height &#39;. Roi has not been set.&quot;</span></div><div class="line">                      &lt;&lt; std::endl;</div><div class="line">            roi.clear();</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    std::cout &lt;&lt; program_desc &lt;&lt; std::endl;</div><div class="line"></div><div class="line">    <span class="keywordflow">do</span> {</div><div class="line">        <a class="code" href="classProphesee_1_1Camera.html">Prophesee::Camera</a> camera;</div><div class="line">        <span class="keywordtype">bool</span> camera_is_opened = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="comment">// If the filename is set, then read from the file</span></div><div class="line">        <span class="keywordflow">if</span> (filename != <span class="stringliteral">&quot;&quot;</span>) {</div><div class="line">            <span class="keywordflow">if</span> (!serial.empty()) {</div><div class="line">                std::cerr &lt;&lt; <span class="stringliteral">&quot;Error: flag --serial and --filename are not compatible.&quot;</span> &lt;&lt; std::endl;</div><div class="line">                <span class="keywordflow">return</span> 1;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">try</span> {</div><div class="line">                camera           = <a name="a17"></a><a class="code" href="classProphesee_1_1Camera.html#afa792df12f4df374f89b7127c2256fd6">Prophesee::Camera::from_file</a>(filename);</div><div class="line">                camera_is_opened = <span class="keyword">true</span>;</div><div class="line">            } <span class="keywordflow">catch</span> (<a class="code" href="classProphesee_1_1CameraException.html">Prophesee::CameraException</a> &amp;e) { std::cerr &lt;&lt; e.what() &lt;&lt; std::endl; }</div><div class="line">            <span class="comment">// Otherwise, set the input source to the fist available camera</span></div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">            <span class="keywordflow">try</span> {</div><div class="line">                <span class="keywordflow">if</span> (!serial.empty()) {</div><div class="line">                    camera = <a name="a18"></a><a class="code" href="classProphesee_1_1Camera.html#a9d86dd13e0b131ef63525f59ad0b97a7">Prophesee::Camera::from_serial</a>(serial);</div><div class="line">                } <span class="keywordflow">else</span> {</div><div class="line">                    camera = <a name="a19"></a><a class="code" href="classProphesee_1_1Camera.html#afdaf3683127939d36aee0def215b11c0">Prophesee::Camera::from_first_available</a>();</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (biases_file != <span class="stringliteral">&quot;&quot;</span>) {</div><div class="line">                    camera.<a name="a20"></a><a class="code" href="classProphesee_1_1Camera.html#a270ed22176f8767a23d1867453fc7bc7">biases</a>().<a name="a21"></a><a class="code" href="classProphesee_1_1Biases.html#aeef41dd5c1a7f1773c91d038c3c4d803">set_from_file</a>(biases_file);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (!roi.empty()) {</div><div class="line">                    camera.<a name="a22"></a><a class="code" href="classProphesee_1_1Camera.html#aedab5fb7f1a3208d0f0d67336d7b61f2">roi</a>().<a name="a23"></a><a class="code" href="classProphesee_1_1Roi.html#af43deb2fe4c5ebd61fa6b7c8da77f2bc">set</a>({roi[0], roi[1], roi[2], roi[3]});</div><div class="line">                }</div><div class="line">                camera_is_opened = <span class="keyword">true</span>;</div><div class="line">            } <span class="keywordflow">catch</span> (<a class="code" href="classProphesee_1_1CameraException.html">Prophesee::CameraException</a> &amp;e) { std::cerr &lt;&lt; e.what() &lt;&lt; std::endl; }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (!camera_is_opened) {</div><div class="line">            <span class="keywordflow">if</span> (do_retry) {</div><div class="line">                std::this_thread::sleep_for(std::chrono::seconds(1));</div><div class="line">                std::cout &lt;&lt; <span class="stringliteral">&quot;Trying to reopen camera...&quot;</span> &lt;&lt; std::endl;</div><div class="line">                <span class="keywordflow">continue</span>;</div><div class="line">            } <span class="keywordflow">else</span> {</div><div class="line">                <span class="keywordflow">return</span> -1;</div><div class="line">            }</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">            std::cout &lt;&lt; <span class="stringliteral">&quot;Camera has been opened successfully.&quot;</span> &lt;&lt; std::endl;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Add runtime error callback</span></div><div class="line">        camera.<a name="a24"></a><a class="code" href="classProphesee_1_1Camera.html#a603e4da11265314815b9c8fe07ab44c9">add_runtime_error_callback</a>([&amp;do_retry](<span class="keyword">const</span> <a class="code" href="classProphesee_1_1CameraException.html">Prophesee::CameraException</a> &amp;e) {</div><div class="line">            std::cerr &lt;&lt; e.what() &lt;&lt; std::endl;</div><div class="line">            do_retry = <span class="keyword">true</span>;</div><div class="line">        });</div><div class="line"></div><div class="line">        <span class="comment">// Get the geometry of the camera</span></div><div class="line">        <span class="keyword">auto</span> &amp;geometry = camera.<a class="code" href="classProphesee_1_1Camera.html#add2264902d5c3cfe0c031ddf1ec693a0">geometry</a>(); <span class="comment">// Get the geometry of the camera</span></div><div class="line"></div><div class="line">        <span class="comment">// All Prophesee cameras have at least CDs</span></div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> cd_available = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keywordtype">bool</span> cd_frame_activated = cd_available;</div><div class="line">        std::string cd_window_name(<span class="stringliteral">&quot;CD Events&quot;</span>);</div><div class="line">        cv::Mat cd_frame;</div><div class="line">        <a class="code" href="classProphesee_1_1CDFrameGenerator.html">Prophesee::CDFrameGenerator</a> cd_frame_generator(geometry.width(), geometry.height());</div><div class="line">        cd_frame_generator.<a name="a25"></a><a class="code" href="classProphesee_1_1CDFrameGenerator.html#a18e90e3057ce120f9eca29b6dc064bbd">set_display_accumulation_time_us</a>(10000);</div><div class="line">        <span class="keywordtype">int</span> cd_events_cb_id = setup_cd_callback_and_window(camera, cd_frame, cd_frame_generator, cd_window_name);</div><div class="line"></div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> em_available = camera.<a name="a26"></a><a class="code" href="classProphesee_1_1Camera.html#a8b9f8f0087e6178551367901ee5ff84a">generation</a>().<a name="a27"></a><a class="code" href="classProphesee_1_1CameraGeneration.html#a7b56c78796dde724116a145a1fb57e0b">type</a>() == <a name="a28"></a><a class="code" href="classProphesee_1_1CameraGeneration.html#a9ab70bf784916bd3832e8543925a102dab95c3d50fa47443166f7d356eaed8006">Prophesee::CameraGeneration::Type::EM</a>;</div><div class="line"></div><div class="line">        <span class="keywordtype">bool</span> graylevel_frame_activated = em_available;</div><div class="line">        std::string graylevel_frame_window_name(<span class="stringliteral">&quot;GrayLevel frame&quot;</span>);</div><div class="line">        cv::Mat graylevel_frame;</div><div class="line">        Prophesee::Utils::GammaToneMapper tone_mapper;</div><div class="line">        <span class="keywordtype">int</span> graylevel_frame_cb_ret = em_available ?</div><div class="line">                                         setup_graylevel_frame_callback_and_window(camera, graylevel_frame, tone_mapper,</div><div class="line">                                                                                   graylevel_frame_window_name) :</div><div class="line">                                         -1;</div><div class="line"></div><div class="line">        <span class="keywordtype">bool</span> em_frame_activated = <span class="keyword">false</span>;</div><div class="line">        std::string em_window_name(<span class="stringliteral">&quot;EM Events&quot;</span>);</div><div class="line">        cv::Mat em_frame;</div><div class="line">        <a class="code" href="classProphesee_1_1EMFrameGenerator.html">Prophesee::EMFrameGenerator</a> em_frame_generator(geometry.width(), geometry.height());</div><div class="line">        <span class="comment">// No EM callback by default, can be enabled with &#39;e&#39;</span></div><div class="line">        <span class="keywordtype">int</span> em_events_cb_id = -1;</div><div class="line"></div><div class="line">        <span class="comment">// Imu informations</span></div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">bool</span> imu_available = is_imu_available(camera);</div><div class="line">        <span class="keywordtype">bool</span> show_imu_data(<span class="keyword">false</span>);</div><div class="line">        <a class="code" href="namespaceProphesee.html#af918f8b09ed1677cdc64cabc71e30aa8">Prophesee::CallbackId</a> imu_id(std::numeric_limits&lt;Prophesee::CallbackId&gt;::max());</div><div class="line"></div><div class="line">        <span class="comment">// Start the camera streaming</span></div><div class="line">        camera.<a name="a29"></a><a class="code" href="classProphesee_1_1Camera.html#a59432c0a31a8d9ba13183515bcd3e96f">start</a>();</div><div class="line"></div><div class="line">        <span class="keywordtype">bool</span> recording             = <span class="keyword">false</span>;</div><div class="line">        <span class="keywordtype">bool</span> is_roi_set            = <span class="keyword">true</span>;</div><div class="line">        <span class="keywordtype">bool</span> max_event_rate_active = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">while</span> (camera.<a name="a30"></a><a class="code" href="classProphesee_1_1Camera.html#aad0457ad6cdd13d4940e316a94afb015">is_running</a>()) {</div><div class="line">            <span class="comment">// Make sure that at least one window is always opened</span></div><div class="line">            <span class="keywordflow">if</span> (!cd_frame_activated &amp;&amp; !em_frame_activated &amp;&amp; !graylevel_frame_activated) {</div><div class="line">                cd_frame_activated = <span class="keyword">true</span>;</div><div class="line">                cd_events_cb_id    = setup_cd_callback_and_window(camera, cd_frame, cd_frame_generator, cd_window_name);</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (cd_frame_activated &amp;&amp; !cd_frame.empty())</div><div class="line">                cv::imshow(cd_window_name, cd_frame);</div><div class="line">            <span class="keywordflow">if</span> (em_frame_activated &amp;&amp; !em_frame.empty())</div><div class="line">                cv::imshow(em_window_name, em_frame);</div><div class="line">            <span class="keywordflow">if</span> (graylevel_frame_activated &amp;&amp; !graylevel_frame.empty())</div><div class="line">                cv::imshow(graylevel_frame_window_name, graylevel_frame);</div><div class="line"></div><div class="line">            <span class="comment">// Wait for a pressed key for 33ms, that means that the display is refreshed at 30 FPS</span></div><div class="line">            <span class="keywordtype">int</span> key = process_ui_for(33);</div><div class="line">            <span class="keywordflow">switch</span> (key) {</div><div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;q&#39;</span>:</div><div class="line">            <span class="keywordflow">case</span> ESCAPE:</div><div class="line">                camera.<a name="a31"></a><a class="code" href="classProphesee_1_1Camera.html#a12cad0dd2ddade5068cbee28f6933b36">stop</a>();</div><div class="line">                do_retry = <span class="keyword">false</span>;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">case</span> SPACE:</div><div class="line">                <span class="keywordflow">if</span> (!recording) {</div><div class="line">                    camera.<a name="a32"></a><a class="code" href="classProphesee_1_1Camera.html#a2ec0701f63c2b9b6b81383997103c8ca">start_recording</a>(filename_to_log_into);</div><div class="line">                } <span class="keywordflow">else</span> {</div><div class="line">                    camera.<a name="a33"></a><a class="code" href="classProphesee_1_1Camera.html#ae21bb53ac883e9c1fa8cdfecc00924e3">stop_recording</a>();</div><div class="line">                }</div><div class="line">                recording = !recording;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:</div><div class="line">                <span class="keywordflow">if</span> (cd_frame_activated) {</div><div class="line">                    camera.<a class="code" href="classProphesee_1_1Camera.html#a49241bf1af8d9e935a6a4c849892b299">cd</a>().<a name="a34"></a><a class="code" href="classProphesee_1_1CD.html#a82a6fe47ae8094c66f7c17f74cfc38a7">remove_callback</a>(static_cast&lt;Prophesee::CallbackId&gt;(cd_events_cb_id));</div><div class="line">                    cd_frame_generator.<a name="a35"></a><a class="code" href="classProphesee_1_1CDFrameGenerator.html#ad1fcc3081a92eebdbbe9b388c1532835">stop</a>();</div><div class="line">                    cv::destroyWindow(cd_window_name);</div><div class="line">                } <span class="keywordflow">else</span> {</div><div class="line">                    cd_events_cb_id =</div><div class="line">                        setup_cd_callback_and_window(camera, cd_frame, cd_frame_generator, cd_window_name);</div><div class="line">                }</div><div class="line">                cd_frame_activated = !cd_frame_activated;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span>: {</div><div class="line">                <span class="keywordflow">if</span> (roi.size() == 0) {</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (!is_roi_set) {</div><div class="line">                    camera.<a class="code" href="classProphesee_1_1Camera.html#aedab5fb7f1a3208d0f0d67336d7b61f2">roi</a>().<a class="code" href="classProphesee_1_1Roi.html#af43deb2fe4c5ebd61fa6b7c8da77f2bc">set</a>({roi[0], roi[1], roi[2], roi[3]});</div><div class="line">                } <span class="keywordflow">else</span> {</div><div class="line">                    camera.<a class="code" href="classProphesee_1_1Camera.html#aedab5fb7f1a3208d0f0d67336d7b61f2">roi</a>().<a name="a36"></a><a class="code" href="classProphesee_1_1Roi.html#aedc67f151d88641980de2d6a2c65d932">unset</a>();</div><div class="line">                }</div><div class="line">                is_roi_set = !is_roi_set;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>: {</div><div class="line">                <span class="keywordflow">if</span> (imu_available) {</div><div class="line">                    <span class="keywordflow">if</span> (show_imu_data) {</div><div class="line">                        <span class="comment">// Disable cb</span></div><div class="line">                        camera.<a name="a37"></a><a class="code" href="classProphesee_1_1Camera.html#afaa6d477ebecfec7c918f42eda6ed82a">imu</a>().<a name="a38"></a><a class="code" href="classProphesee_1_1Imu.html#a5a1a4a14f2e13cc8b386c1db02ae4357">remove_callback</a>(imu_id);</div><div class="line"></div><div class="line">                        <span class="comment">// If from online source, no need to have the imu events anymore, since no cb is associated to</span></div><div class="line">                        <span class="comment">// imu events :</span></div><div class="line">                        <span class="keywordflow">if</span> (filename.empty()) {</div><div class="line">                            camera.<a class="code" href="classProphesee_1_1Camera.html#a3bca5213536c49a585fd827876882ca2">imu_sensor</a>().<a name="a39"></a><a class="code" href="classProphesee_1_1ImuSensor.html#a7988f6796e148653574d1fe70063de1e">disable</a>();</div><div class="line">                        }</div><div class="line">                    } <span class="keywordflow">else</span> {</div><div class="line">                        <span class="comment">// Enable imu cb</span></div><div class="line"></div><div class="line">                        <span class="comment">// If from online source, we need to enable the imu events in the sensor :</span></div><div class="line">                        <span class="keywordflow">if</span> (filename.empty()) {</div><div class="line">                            camera.<a class="code" href="classProphesee_1_1Camera.html#a3bca5213536c49a585fd827876882ca2">imu_sensor</a>().<a name="a40"></a><a class="code" href="classProphesee_1_1ImuSensor.html#ac6a82e053f433ab6635b2da4dd4291e5">enable</a>();</div><div class="line">                        }</div><div class="line"></div><div class="line">                        imu_id = camera.<a class="code" href="classProphesee_1_1Camera.html#afaa6d477ebecfec7c918f42eda6ed82a">imu</a>().<a name="a41"></a><a class="code" href="classProphesee_1_1Imu.html#ab3cb9f7d801631613eab63189c05e321">add_callback</a>(</div><div class="line">                            [](<span class="keyword">const</span> <a name="_a42"></a><a class="code" href="classProphesee_1_1EventIMU.html">Prophesee::EventIMU</a> *begin, <span class="keyword">const</span> <a class="code" href="classProphesee_1_1EventIMU.html">Prophesee::EventIMU</a> *end) {</div><div class="line">                                <span class="keywordflow">for</span> (<span class="keyword">auto</span> it = begin; it != end; ++it) {</div><div class="line">                                    std::cout &lt;&lt; <span class="stringliteral">&quot;(ax, ay, az, gx, gy, gz) : (&quot;</span> &lt;&lt; it-&gt;ax &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; it-&gt;ay &lt;&lt; <span class="stringliteral">&quot;, &quot;</span></div><div class="line">                                              &lt;&lt; it-&gt;az &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; it-&gt;gx &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; it-&gt;gy &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; it-&gt;gz &lt;&lt; <span class="stringliteral">&quot;)&quot;</span></div><div class="line">                                              &lt;&lt; std::endl;</div><div class="line">                                }</div><div class="line">                            });</div><div class="line">                    }</div><div class="line">                    show_imu_data = !show_imu_data;</div><div class="line">                } <span class="keywordflow">else</span> {</div><div class="line">                    std::cerr &lt;&lt; <span class="stringliteral">&quot;The camera does not output IMU information.&quot;</span> &lt;&lt; std::endl;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;e&#39;</span>:</div><div class="line">                <span class="keywordflow">if</span> (em_available) {</div><div class="line">                    <span class="keywordflow">if</span> (em_frame_activated) {</div><div class="line">                        camera.<a class="code" href="classProphesee_1_1Camera.html#aa90e9aab54d8beabf380bd7eee7f5994">em</a>().<a name="a43"></a><a class="code" href="classProphesee_1_1EM.html#a41d2fb5af8928af861e7ef1c4b9b52b5">remove_callback</a>(static_cast&lt;Prophesee::CallbackId&gt;(em_events_cb_id));</div><div class="line">                        em_frame_generator.<a name="a44"></a><a class="code" href="classProphesee_1_1EMFrameGenerator.html#a674cf0a1ad4c8b39f2012b5f3aa40beb">stop</a>();</div><div class="line">                        cv::destroyWindow(em_window_name);</div><div class="line">                        em_frame_activated = <span class="keyword">false</span>;</div><div class="line">                    } <span class="keywordflow">else</span> {</div><div class="line">                        em_events_cb_id =</div><div class="line">                            setup_em_callback_and_window(camera, em_frame, em_frame_generator, em_window_name);</div><div class="line">                        em_frame_activated = (em_events_cb_id &gt;= 0);</div><div class="line">                    }</div><div class="line">                }</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;f&#39;</span>:</div><div class="line">                <span class="keywordflow">if</span> (em_available) {</div><div class="line">                    <span class="keywordflow">if</span> (graylevel_frame_activated) {</div><div class="line">                        camera.<a name="a45"></a><a class="code" href="classProphesee_1_1Camera.html#adba800dd4a0a35b99c0c40c805def89b">unset_exposure_frame_callback</a>();</div><div class="line">                        cv::destroyWindow(graylevel_frame_window_name);</div><div class="line">                        graylevel_frame_activated = <span class="keyword">false</span>;</div><div class="line">                    } <span class="keywordflow">else</span> {</div><div class="line">                        graylevel_frame_cb_ret = setup_graylevel_frame_callback_and_window(</div><div class="line">                            camera, graylevel_frame, tone_mapper, graylevel_frame_window_name);</div><div class="line">                        graylevel_frame_activated = (graylevel_frame_cb_ret &gt;= 0);</div><div class="line">                    }</div><div class="line">                }</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:</div><div class="line">                <span class="keywordflow">if</span> (max_event_rate_active) {</div><div class="line">                    camera.<a name="a46"></a><a class="code" href="classProphesee_1_1Camera.html#ae3211519fe6e26255f93bd095aeed2e0">set_max_event_rate_limit</a>(0);</div><div class="line">                } <span class="keywordflow">else</span> {</div><div class="line">                    camera.<a class="code" href="classProphesee_1_1Camera.html#ae3211519fe6e26255f93bd095aeed2e0">set_max_event_rate_limit</a>(max_rate_kEV_s);</div><div class="line">                }</div><div class="line">                max_event_rate_active = !max_event_rate_active;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:</div><div class="line">                std::cout &lt;&lt; program_desc &lt;&lt; std::endl;</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">default</span>:</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// unregister callbacks to make sure they are not called anymore</span></div><div class="line">        <span class="keywordflow">if</span> (cd_events_cb_id &gt;= 0) {</div><div class="line">            camera.<a class="code" href="classProphesee_1_1Camera.html#a49241bf1af8d9e935a6a4c849892b299">cd</a>().<a class="code" href="classProphesee_1_1CD.html#a82a6fe47ae8094c66f7c17f74cfc38a7">remove_callback</a>(cd_events_cb_id);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (em_events_cb_id &gt;= 0) {</div><div class="line">            camera.<a class="code" href="classProphesee_1_1Camera.html#aa90e9aab54d8beabf380bd7eee7f5994">em</a>().<a class="code" href="classProphesee_1_1EM.html#a41d2fb5af8928af861e7ef1c4b9b52b5">remove_callback</a>(em_events_cb_id);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span> (graylevel_frame_cb_ret &gt;= 0) {</div><div class="line">            camera.<a class="code" href="classProphesee_1_1Camera.html#adba800dd4a0a35b99c0c40c805def89b">unset_exposure_frame_callback</a>();</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Stop the camera straming, optional, the destructor will automatically do it</span></div><div class="line">        camera.<a class="code" href="classProphesee_1_1Camera.html#a12cad0dd2ddade5068cbee28f6933b36">stop</a>();</div><div class="line">    } <span class="keywordflow">while</span> (do_retry);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
